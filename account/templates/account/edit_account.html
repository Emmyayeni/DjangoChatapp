{% extends 'base.html' %}
{% load static %}

{% block content %}
    <main class="update-account layout--1 pt-5">
        <div class="layout__box card">
            <div class="card-header d-flex align-items-center justify-content-between bg-white border-bottom-0 pt-4 px-4">
                <div class="layout__boxTitle d-flex align-items-center gap-3">
                    <a href="{% url 'account:view' user_id=request.user.id %}" class="text-decoration-none text-dark">
                        <i class="fas fa-arrow-left fa-lg"></i>
                    </a>
                    <h3 class="m-0">Edit your profile</h3>
                </div>
            </div>
            <div class="card-body p-4">
                <!-- Image Cropper Controls -->
                <div class="mb-2 d-none" id="id_image_crop_confirm">
                    <span id="id_cancel" class="btn btn-danger btn-sm"><i class="fas fa-times"></i> Cancel</span>
                    <span id="id_confirm" class="btn btn-success btn-sm"><i class="fas fa-check"></i> Confirm</span>
                </div>
                
                <div class="image-container text-center mb-4 position-relative" id="id_image_container" style="cursor: pointer;">
                    <img class="rounded-circle img-fluid profile-image" id="id_profile_image_display" src="{{form.initial.profile_image.url}}" style="width:150px;height:150px; object-fit: cover;">
                    <div class="middle position-absolute top-50 start-50 translate-middle" id="id_middle_container" style="opacity: 0; transition: .5s ease;">
                        <div class="btn btn-light rounded-circle p-2" id="id_text"><i class="fas fa-camera fa-2x text-primary"></i></div>
                    </div>
                </div>

                <form class="form" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input class="d-none" type="file" name="profile_image" id="id_profile_image" onchange="readURL(this)">
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" name="hide_email" id="id_input_hide_email" {% if form.initial.hide_email %}checked{%endif%}>
                        <label class="form-check-label" for="id_input_hide_email">Hide Email</label>
                    </div>

                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input id="username" name="username" type="text" class="form-control" placeholder="E.g. John doe" value="{{form.initial.username}}" />
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input id="email" name="email" type="text" class="form-control" placeholder="E.g. john@email.com" value="{{form.initial.email}}" />
                    </div>

                    <div class="mb-3">
                        <label for="user_bio" class="form-label">Bio</label>
                        <textarea name="bio" id="user_bio" class="form-control" rows="4">{{form.initial.bio}}</textarea>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <a class="btn btn-secondary" href="{% url 'account:view' user_id=request.user.id %}">Cancel</a>
                        <button class="btn btn--main" type="submit">Update</button>
                    </div>
                
                    {% if form.errors %}
                        <div class="alert alert-danger mt-3">
                            {% for field in form %}
                                {% for error in field.errors %}
                                    <p class="mb-0">{{ error }}</p>
                                {% endfor %}
                            {% endfor %}
                            {% if form.non_field_errors %}
                                <p class="mb-0">{{form.non_field_errors}}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </main>

<script type="text/javascript">

	var cropper;
	var imageFile;
	var base64ImageString;
	var cropX;
	var cropX;
	var cropWidth;
	var cropHeight;

	enableImageOverlay()

	function enableImageOverlay(){
		var text = document.getElementById("id_text")
		// text.style.color = "#5995fd"
		// text.style.fontSize = "30px"
		// text.style.padding = "2px"
		text.style.cursor = "pointer"

		var profileImage = document.getElementById("id_profile_image")
		profileImage.style.opacity = "1"
		profileImage.style.display = "block"
		profileImage.style.width = "100%"
		profileImage.style.height = "auto"
		profileImage.style.transition = ".5s ease"
		profileImage.style.backfaceVisibility  = "hidden"
		profileImage.style.cursor = "pointer"

		var middleContainer = document.getElementById("id_middle_container")
		middleContainer.style.transition = ".5s ease"
		middleContainer.style.opacity = "0"
		middleContainer.style.position = "absolute"
		middleContainer.style.top = "50%"
		middleContainer.style.left = "50%"
		middleContainer.style.transform = "translate(-50%, -50%)"
		middleContainer.style.textAlign = "center"

		var imageContainer = document.getElementById("id_image_container")
		imageContainer.addEventListener("mouseover", function( event ) { 
			document.getElementById("id_profile_image_display").style.opacity = "0.3"
			middleContainer.style.opacity = "1"
		})

		imageContainer.addEventListener("mouseout", function( event ) { 
			document.getElementById("id_profile_image_display").style.opacity = "1"
			middleContainer.style.opacity = "0"
		})

		imageContainer.addEventListener("click", function(event){
			document.getElementById('id_profile_image').click();
		});

		var cropConfirm = document.getElementById("id_image_crop_confirm")
		cropConfirm.classList.remove("d-flex")
		cropConfirm.classList.remove("flex-row")
		cropConfirm.classList.remove("justify-content-between")
		cropConfirm.classList.add("d-none")
		
	}

	function disableImageOverlay(){
		var profileImage = document.getElementById("id_profile_image_display")
		var middleContainer = document.getElementById("id_middle_container")
		var imageContainer = document.getElementById("id_image_container")
		var text = document.getElementById("id_text")

		imageContainer.removeEventListener("mouseover", function( event ) { 
			profileImage.style.opacity = "0.3"
			middleContainer.style.opacity = "1"
		})

		imageContainer.removeEventListener("mouseout", function( event ) { 
			profileImage.style.opacity = "1"
			middleContainer.style.opacity = "0"
		})

		profileImage.style.opacity = "1"
		middleContainer.style.opacity = "0"
		text.style.cursor = "default"
		text.style.opacity = "0"

		document.getElementById('id_image_container').removeEventListener("click", function(event){
			event.preventDefault();
			// do nothing
		});
		document.getElementById('id_profile_image').addEventListener("click", function(event){
			event.preventDefault();
			// do nothing
		});

		var cropConfirm = document.getElementById("id_image_crop_confirm")
		cropConfirm.classList.remove("d-none")
		cropConfirm.classList.add("d-flex")
		cropConfirm.classList.add("flex-row")
		cropConfirm.classList.add("justify-content-between")

		var confirm = document.getElementById("id_confirm")
		confirm.addEventListener("click", function(event){
			console.log("Sending crop data for processing...")
			cropImage(
				imageFile, 
				cropX, 
				cropY, 
				cropWidth,
				cropHeight
			)
		})
		/* Refresh the browser */

		var cancel = document.getElementById("id_cancel")
		cancel.addEventListener("click", function(event){
			console.log("Reloading window...")
			window.location.reload();
		})
	}

	/* return null if invalid or base64String if valid */
	function isImageSizeValid(image){
		console.log("max size: {{DATA_UPLOAD_MAX_MEMORY_SIZE}}")
		// console.log(image)
		var startIndex = image.indexOf("base64,") + 7;
		var base64str = image.substr(startIndex);
		var decoded = atob(base64str);
		console.log("FileSize: " + decoded.length);
		if(decoded.length >= "{{DATA_UPLOAD_MAX_MEMORY_SIZE}}"){
			return null
		}
		return base64str
	}
	/* the cropimage  function */

	function cropImage(image, x, y, width, height){
		base64ImageString = isImageSizeValid(image)

		if(base64ImageString != null){
			var requestData = {
				"csrfmiddlewaretoken": "{{ csrf_token }}",
				"image": base64ImageString,
				"cropX": cropX,
				"cropY": cropY,
				"cropWidth": cropWidth,
				"cropHeight": cropHeight
			}
			displayLoadingSpinner(true)
			$.ajax({
				type: 'POST',
				dataType: "json",
				url: "{% url 'account:crop_image' user_id=form.initial.id %}",
				data: requestData,
				timeout: 60000,
				success: function(data) {
					if(data.result == "success"){
						document.getElementById("id_cancel").click()
					}
					else if(data.result == "error"){
						alert(data.exception)
						document.getElementById("id_cancel").click()
					}
				},
				error: function(data) {
					console.error("ERROR...", data)
				},
				complete: function(data){
					displayLoadingSpinner(false)
				}
			});
		}
		else{
			alert("Upload an image smaller than 10 MB");
			document.getElementById("id_cancel").click()
		}
	}

	/*
		Called when a new image is selected from file chooser dialog
	*/
	function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
            	disableImageOverlay()
            	var image = e.target.result
            	var imageField = document.getElementById('id_profile_image_display')
                imageField.src = image
				cropper = new Cropper(imageField, {
					aspectRatio: 1/1,
					crop(event) {
						// console.log("CROP START")
						// console.log("x: " + event.detail.x);
						// console.log("y: " + event.detail.y);
						// console.log("width: " + event.detail.width);
						// console.log("height: " + event.detail.height);
						setImageCropProperties(
							image,
							event.detail.x,
							event.detail.y,
							event.detail.width,
							event.detail.height
						)
					},
				});
            };
            reader.readAsDataURL(input.files[0]);
        }
    };

	/* the properties of the image as selected */
    function setImageCropProperties(image, x, y, width, height){
		imageFile = image
		cropX = x
		cropY = y
		cropWidth = width
		cropHeight = height
	}

</script>
{% endblock content %}