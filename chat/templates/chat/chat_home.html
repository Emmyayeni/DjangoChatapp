{% extends 'base.html' %}
{% load static %}

{% block content %}
<script src="{% static "js/jquery.min.js" %}"></script>
<script src="{% static "bud/tinymce.min.js" %}"></script>
<p class="d-none" id="id_page_number">0</p>

<main class="pt-4 profile-page layout layout--2">
    
    <!-- Room Start -->
    <div class="room">
        <div class="room__top">
            <div class="room__topLeft">
                <a href="{% url 'home' %}" class="me-3">
                    <i class="fas fa-arrow-left fa-lg"></i>
                </a>
                <!-- Mobile Friends Toggle -->
                <button class="btn btn-sm btn-light d-lg-none me-2" id="id_mobile_friends_toggle">
                    <i class="fas fa-users"></i>
                </button>
                <a href="" id="id_user_info_container" class="d-flex align-items-center gap-2 text-decoration-none text-dark">
                    <div class="avatar avatar--small">
                        <img id="id_other_user_profile_image" src="{% static 'img/avatar.png' %}" class="d-none">
                    </div>
                    <h3 id="id_other_username" class="m-0">Select a friend</h3>
                </a>
            </div>
            <div class="room__topRight">
                <!-- Optional actions -->
            </div>
        </div>
        
        <div class="room__box scrollable" id="threads-scroll">
            <!-- Chat messages will be appended here by JS -->
             
            <!-- Empty State / Welcome Screen -->
            <div id="id_chat_empty_state" class="d-flex flex-column align-items-center justify-content-center w-100 text-center p-4 position-absolute top-50 start-50 translate-middle" style="z-index: 0;">
                <div class="mb-3 text-primary" style="opacity: 0.8;">
                    <i class="fas fa-comments fa-4x"></i>
                </div>
                <h3 class="fw-bold mb-2">Your Messages</h3>
                <p class="text-muted">Select a friend to start chatting.</p>
            </div>

            <div class="d-flex flex-row justify-content-center align-items-center w-100 h-100 position-absolute top-0 start-0 bg-white" id="id_chatroom_loading_spinner" role="status" style="display: none; z-index: 10;">
                <div class="spinner-border text-primary"  role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>

        <div class="room__message">
            <div class="chat-message-input-container">
                <textarea name="body" id="id_chat_message_input" class="chat-message-input" placeholder="Write your message..."></textarea>
                <button class="chat-message-submit-button" id="id_chat_message_submit"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
    <!-- Room End -->

    <!-- Participants / Friend List Start -->
    <div class="participants" id="id_participants_container">
        <div class="participants__top d-flex justify-content-between align-items-center">
            <h3 class="m-0">Friends</h3>
            <!-- Close button for mobile -->
            <button class="btn btn-sm btn-icon d-lg-none" id="id_mobile_friends_close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="participants__list scrollable">
            {% for x in m_and_f %}
            <div class="participant" onclick="onSelectFriend('{{x.friend.id}}')" id="id_friend_container_{{x.friend.id}}">
                <div class="avatar avatar--medium">
                    <img src="{{x.friend.profile_image.url}}" id="id_friend_img_{{x.friend.id}}" alt="{{x.friend.username}}">
                </div>
                <p>
                    <span class="username-span">{{x.friend.username}}</span>
                    <span class="friend-message-span">{{x.message|truncatechars:20}}</span>
                </p>
                <!-- Hidden ID for mobile compatibility if needed by JS -->
                <span id="id_friend_containe_{{x.friend.id}}" class="d-none"></span>
            </div>
            {% endfor %}
        </div>
    </div>
    <!-- Participants End -->
    
    <!-- Client Error MODAL -->
    <button type="button" id="id_trigger_client_error_modal" class="d-none btn btn-primary" data-toggle="modal" data-target="#id_client_error_modal">
    </button>
    <div class="modal fade" id="id_client_error_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Socket Client Error</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="id_client_error_modal_body">Something went wrong.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="id_client_error_modal_close_btn">Close</button>
                </div>
            </div>
        </div>
    </div>
</main>

<script type="text/javascript">
    var chatSocket = null;
    var roomId = null;

    // Mobile UI Handlers
    const participantsContainer = document.getElementById('id_participants_container');
    const mobileFriendsToggle = document.getElementById('id_mobile_friends_toggle');
    const mobileFriendsClose = document.getElementById('id_mobile_friends_close');

    if (mobileFriendsToggle) {
        mobileFriendsToggle.addEventListener('click', function() {
            participantsContainer.classList.add('show-mobile');
        });
    }

    if (mobileFriendsClose) {
        mobileFriendsClose.addEventListener('click', function() {
            participantsContainer.classList.remove('show-mobile');
        });
    }

    // Hide empty state when selecting a chat
    function hideEmptyState() {
        const emptyState = document.getElementById('id_chat_empty_state');
        if (emptyState) {
            emptyState.style.display = 'none';
        }
    }

    // Show empty state when cleared or invalid
    function showEmptyState() {
        const emptyState = document.getElementById('id_chat_empty_state');
        if (emptyState) {
            emptyState.style.display = 'flex';
        }
    }

    onStart()
    function onStart(){
        {% if room %}
            if("{{room.user1}}" == "{{request.user}}"){
                onSelectFriend("{{room.user2.id}}")
            }
            else{
                onSelectFriend("{{room.user1.id}}")
            }
        {% else %}
            {% if m_and_f %} 
                onSelectFriend('{{m_and_f.0.friend.id}}')
             {% endif %}
        {% endif %}
        
        {% for x in m_and_f %}
            preloadImage("{{x.friend.profile_image.url|safe}}", "id_friend_img_{{x.friend.id}}")
        {% endfor %}
    }

    function onSelectFriend(userId){
        createOrReturnPrivateChat(userId)
        clearHighlightedFriend()
        highlightFriend(userId)
        hideEmptyState(); // Hide welcome screen when chat starts
        
        // On mobile, close sidebar after selection
        if (window.innerWidth < 992) {
            participantsContainer.classList.remove('show-mobile');
        }
    }

    function closeWebSocket(){
        if(chatSocket !=null)
            chatSocket.close()
            chatSocket = null
            clearChatLog()
            setPageNumber("1")
            disableChatLogScrollListener()
     }
    
    document.getElementById('id_chat_message_input').focus();
    document.getElementById('id_chat_message_input').onkeyup = function(e){
        if (e.keyCode === 13 && e.shiftKey) {  // enter + return
            // Handled automatically by textarea
        }
        else if(e.keyCode === 13 && !e.shiftKey){ // enter + !return
            document.getElementById('id_chat_message_submit').click();
        }
    };
 
    document.getElementById('id_chat_message_submit').onclick = function(e) {
        const messageInputDom = document.getElementById('id_chat_message_input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            "command": "send",
            "message": message,
            "room": roomId
        }));
        messageInputDom.value = '';
    };

   function setupWebSocket(room_id){

    console.log("setupWebSocket: " + room_id)

    roomId = room_id

    // close previous socket if one is open
    closeWebSocket()

    // Correctly decide between ws:// and wss://
    var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    {% if debug_mode %}
        var ws_path = ws_scheme + '://' + window.location.host + "/chat/" + roomId ; // development
    {% else %}
        var ws_path = ws_scheme + '://' + window.location.host + ":8001/chat/" + roomId  ; // production
    {% endif %}
    
    
    // console.log("Connecting to " + ws_path);
    chatSocket = new WebSocket(ws_path);

    // Handle incoming messages
    chatSocket.onmessage = function(message) {
        // Decode the JSON
        // console.log("Got chat websocket message " + message.data);
        console.log("Got websocket message.");
        var datam = JSON.parse(message.data)
        console.log(datam)

        // display the progress bar?
       // displayChatroomLoadingSpinner(datam.display_progress_bar)

        // Handle errors (ClientError)
        if (datam.error) {
            console.error(datam.error + ": " + datam.message)
            showClientErrorModal(datam.error)
        
        }
        // Handle joining (Client perspective)
        if (datam.join) {
            console.log("Joining room " + datam.join);
            getUserInfo();
            getRoomChatMessages()
            enableChatLogScrollListener()
        }
        // Handle leaving (client perspective)
        if (datam.leave) {
            // do nothing
            console.log("Leaving room " + datam.leave);
        }

        // user info coming in from backend
        if(datam.user_info){
            handleUserInfoPayload(datam.user_info)
            console.log("getting user info")
        }
        if(datam.msg_type == 0 || datam.msg_type == 1 || datam.msg_type == 2){
            appendMessage(datam,false,true)
        }
        if(datam.messages_payload){
            handleMesagesPayload(datam.messages,datam.new_page_number)
        }
        
    };

    chatSocket.addEventListener("open", function(e){
        console.log("ChatSocket OPEN")
        // join chat room
        if("{{request.user.is_authenticated}}"){
            chatSocket.send(JSON.stringify({
                "command": "join",
                "room": roomId
            }));
            console.log("sending request" )
            
        }
    })
    chatSocket.onclose = function(e) {
        console.log('Chat socket closed.');
    };

    chatSocket.onOpen = function(e){
        console.log("ChatSocket onOpen", e)
    }

    chatSocket.onerror = function(e){
        console.log('ChatSocket error', e)
    }

    if (chatSocket.readyState == WebSocket.OPEN) {
        console.log("ChatSocket OPEN")
    } else if (chatSocket.readyState == WebSocket.CONNECTING){
        console.log("ChatSocket connecting..")
    }

}
function getUserInfo(){
    chatSocket.send(JSON.stringify({
       "command": "get_user_info",
       "room_id":roomId
    }))
}



function handleUserInfoPayload(user_info){
     document.getElementById("id_other_username").innerHTML = user_info.username;
     document.getElementById("id_other_user_profile_image").classList.remove('d-none');
     document.getElementById("id_user_info_container").href= "{% url 'account:view' user_id=73632839274629 %}".replace("73632839274629",user_info.id);          
     preloadImage(user_info.profile_image,"id_other_user_profile_image");
}

    function showClientErrorModal(message){
        document.getElementById('id_client_error_modal_body').innerHTML = message
        document.getElementById('id_trigger_client_error_modal').click()
    }
    function appendMessage(data,maintainPosition,isNewMessage){
        messageType = data.msg_type
        msg_id = data.msg_id
        message = data.message
        uName = data.username
        user_id = data.user_id
        profile_image = data.profile_image
        timestamp = data.natural_timestamp
        console.log("append new chat messages:" + messageType )
        
        switch(messageType){
            case 0:
                username = uName + ":"
                msg = message + "\n"
                CreatChatMessageElelement(msg,msg_id,username,profile_image,user_id,timestamp,maintainPosition,isNewMessage)
                break;
            case 1:
                createConnectedDisconnectedElement(message,msg_id,profile_image,user_id)
                break
            case 2:
                createConnectedDisconnectedElement(message,msg_id,profile_image,user_id)
                break
            default:
                console.log("Unsupported message type")
                return
        }
        

        
    }
    
    function chatLogScrollListener(e){
        var chatLog = document.getElementById("threads-scroll")
        if((Math.abs(chatLog.scrollTop) + 2) >= (chatLog.scrollHeight - chatLog.offsetHeight)){
            getRoomChatMessages()
        }

    }

    function enableChatLogScrollListener(){
        document.getElementById("threads-scroll").addEventListener("scroll",
        chatLogScrollListener)
    }
    function disableChatLogScrollListener(){
        document.getElementById("threads-scroll").removeEventListener("scroll",
        chatLogScrollListener)
    }
    function displayChatroomLoadingSpinner(isDisplayed){
        var spinner = document.getElementById("id_chatroom_loading_spinner")
        if(isDisplayed){
            spinner.style.display = "block"
        }else{
            spinner.style.display = "none"
        }
    }
function CreatChatMessageElelement(msg,msg_id,username,profile_image,user_id,timestamp,maintainPosition,isNewMessage){
  var chatLog = document.getElementById("threads-scroll");
  var profile_image_id = "id_profile_image_" + msg_id;
  
  var isMe = '{{request.user.id}}' == user_id;
  var alignmentClass = isMe ? "chat-msg--right" : "chat-msg--left";
  
  var msgHtml = `
  <div class="chat-msg ${alignmentClass}">
    <div class="chat-msg__avatar avatar avatar--small">
      <img id="${profile_image_id}" src="{% static 'img/avatar.png' %}"/>
    </div>
    <div class="chat-msg__content">
        <div class="chat-msg__bubble">
            ${msg}
        </div>
        <div class="chat-msg__meta">
            <span class="chat-msg__author">@${username}</span>
            <span class="chat-msg__date">${timestamp}</span>
        </div>
    </div>
  </div>
  `;

  if(isNewMessage){
      chatLog.insertAdjacentHTML("beforeend", msgHtml);
  } else {
      chatLog.insertAdjacentHTML("afterbegin", msgHtml);
  }
  
  if(!maintainPosition){
    chatLog.scrollTop = chatLog.scrollHeight;
  }
  preloadImage(profile_image, profile_image_id);
}
function createConnectedDisconnectedElement(msg, msg_id, profile_image, user_id){
  var chatLog = document.getElementById("threads-scroll");
  var profile_image_id = "id_profile_image_" + msg_id
  
  var msgHtml = `
    <div class="chat-msg chat-msg--system">
        <div class="chat-msg__content">
            <div class="chat-msg__bubble chat-msg__bubble--system">
                <div class="avatar avatar--small d-inline-block me-2">
                  <img id="${profile_image_id}" src="{% static 'img/avatar.png' %}"/>
                </div>
                ${msg}
            </div>
        </div>
    </div>
  `;
  
  chatLog.insertAdjacentHTML("beforeend", msgHtml);
  preloadImage(profile_image, profile_image_id)
 }
    function selectUser(user_id){
        // Weird work-around for passing arg to url
        var url = "{% url 'account:view' user_id=53252623623632623 %}".replace("53252623623632623", user_id)
        var win = window.open(url, "_blank")
        win.focus()
    }
    
    function showClientErrorModal(message){
        document.getElementById("id_client_error_modal_body").innerHTML = message
        document.getElementById("id_trigger_client_error_modal").click()
    }
    
    function displayChatroomLoadingSpinner(isDisplayed){
        var spinner = document.getElementById("id_chatroom_loading_spinner")
        if(isDisplayed){
            spinner.style.display = "block"
        }
        else{
            spinner.style.display = "none"
        }
 	}
    function clearChatLog(){
        document.getElementById("threads-scroll").innerHTML = ""   
        
        // Re-inject empty state (hidden by default since we are likely about to load messages)
        // But if this is called on full clear, we might want to show it.
        // For now, let's just clear. The empty state div was destroyed.
        // We will simple recreate it hidden or rely on standard flow.
        
        // Actually, let's keep the spinner and empty state structure if possible or just rebuild.
        // Easier: Just clear content but preserve the containers if they were outside the log...
        // But currently they are INSIDE .room__box.
        
        // Better approach:
        var chatLog = document.getElementById("threads-scroll");
        
        // Save the spinner and empty state if they exist
        var spinner = document.getElementById("id_chatroom_loading_spinner");
        var emptyState = document.getElementById("id_chat_empty_state");
        
        // Clear all
        chatLog.innerHTML = "";
        
        // Restore empty state (hidden) and spinner (hidden)
        if(emptyState) chatLog.appendChild(emptyState);
        else {
             // Create it if lost? For now let's hope it wasn't needed or handle differently.
             // Actually, clearChatLog is called before loading new chat. 
             // We DO NOT want to show empty state here, we want to show it only on init if no chat.
             // So re-appending it hidden is fine.
             chatLog.insertAdjacentHTML('afterbegin', `
            <div id="id_chat_empty_state" class="d-flex flex-column align-items-center justify-content-center h-100 text-center p-4" style="display:none">
                <div class="mb-4 text-primary opacity-50">
                    <i class="fas fa-comments fa-4x"></i>
                </div>
                <h3 class="fw-bold mb-2">Your Messages</h3>
                <p class="text-muted">Select a friend from the list to start chatting.</p>
            </div>
             `);
        }
        
        if(spinner) chatLog.appendChild(spinner);
        else {
             chatLog.insertAdjacentHTML('beforeend', `
            <div class="d-flex flex-row justify-content-center" id="id_chatroom_loading_spinner" role="status" style="display: none; ">
                <div class="spinner-border text-primary"  role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
             `);
        }
    }
    function setPageNumber(pageNumber){
        document.getElementById("id_page_number").innerHTML = pageNumber
    }
    function SetpaginationExhusted(){
        setPageNumber("-1")
    }

    function getRoomChatMessages(){
        var PageNumber = document.getElementById("id_page_number").innerHTML;
        if(PageNumber != "-1"){
            setPageNumber("-1")
            chatSocket.send(JSON.stringify({
                "command": "get_room_chat_messages",
                "room_id":roomId,
                "page_number": PageNumber
            }))
        }
    }
    function handleMesagesPayload(messages,new_page_number){
        if(messages !=null && messages != "undefined" && messages != "None"){
            setPageNumber(new_page_number)
            messages.forEach(function(message){
                appendMessage(message,true,false)
            })
        }
    }
    function selectUser(user_id){
        var url = "{% url 'account:view' user_id=34354654654645643 %}".replace("34354654654645643",user_id)
        //var win = window.open(url)
        var win = window.location.replace(url)
        win.focus()
    }
    function highlightFriend(userId){
        document.getElementById(`id_friend_container_${userId}`).classList.add('active')
    }
    function clearHighlightedFriend(){
		{% if m_and_f %}
			{% for x in m_and_f %}
				document.getElementById("id_friend_container_{{x.friend.id}}").classList.remove('active')
			{% endfor %}
		{% endif %}

		// clear the profile image and username of current chat
		document.getElementById("id_other_user_profile_image").classList.add("d-none")
		document.getElementById("id_other_user_profile_image").src = "{% static 'img/avatar.png' %}"
		document.getElementById("id_other_username").innerHTML = ""
	}
    function createOrReturnPrivateChat(id){
		payload = {
			"csrfmiddlewaretoken": "{{ csrf_token }}",
			"user2_id": id,
		}
		$.ajax({
			type: 'POST',
			dataType: "json",
			url: "{% url 'chat:create-or-return-private-chat' %}", // production
			data: payload,
			timeout: 5000,
			success: function(data) {
				console.log("SUCCESS", data)
				if(data['response'] == "Successfully got the chat."){
					setupWebSocket(data['chatroom_id'])
				}
				else if(data['response'] != null){
					alert(data['response'])
				}
			},
			error: function(data) {
				console.error("ERROR...", data)
				alert("Something went wrong.")
			},
		});
	}
</script>
{% endblock content %}